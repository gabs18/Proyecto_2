# Visualización integrada de datos en tableros de control

# Preparativos
# Carga de paquetes
library(raster)
library(rmapshaper)
library(dplyr)
library(sf)
library(DT)
library(plotly)
library(leafem)
library(leaflet)
library(leaflet.extras)
library(flexdashboard)

# Carga de datos
orquideas <-
  st_read(
    "https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/gbif/orchidaceae-cr-registros.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude",
      "Y_POSSIBLE_NAMES=decimalLatitude"
    ),
    quiet = TRUE
  )

# Asignar proyecciones
st_crs(orquideas) = 4326

# Capa geespacial de cantones y provincias
cantones <-
  st_read("https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/delimitacion-territorial-administrativa/cr_cantones_simp_wgs84.geojson",
          quiet = TRUE)

provincias <-
  st_read("https://raw.githubusercontent.com/gf0604-procesamientodatosgeograficos/2021i-datos/main/ign/delimitacion-territorial-administrativa/cr_provincias_simp_wgs84.geojson",
          quiet = TRUE)

# Cruce espacial con la tabla de cantones y provincias, para obtener sus nombres
orquideas <- 
  orquideas %>%
  st_join(cantones["canton"]) %>%
  st_join(provincias["provincia"])

# 1. Limpieza
# Conversion de los valores
orquideas <- 
  orquideas %>%
  mutate(coordinateUncertaintyInMeters = as.numeric(coordinateUncertaintyInMeters)) %>%
  mutate(eventDate = as.Date(eventDate, "%Y-%m-%d"))

# Limpieza de los valores de alta incertidumbre (<1000)
orquideas <-
  orquideas %>%
  filter(!is.na(coordinateUncertaintyInMeters) & coordinateUncertaintyInMeters <= 1000)

# 2. Tabla de registros de presencia
orquideas %>%
  st_drop_geometry() %>%
  select(species, eventDate, stateProvince, canton) %>%
  datatable(colnames = c(
    "Especie",
    "Fecha",
    "Provincia",
    "Cantón"), 
    options = list(searchHighlight = TRUE,
                   language = list(url = '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json'),
                   pageLength = 10),
    class = 'cell-border stripe'
  )

# 3. Grafico de pastel
# Especies con mayor cantidad de registros
orq_slice <-
  orquideas %>% 
  st_drop_geometry() %>%
  filter(!is.na(species) & species != "") %>%
  group_by(species) %>% 
  summarise(registros = n()) %>%
  arrange(desc(registros)) %>%
  slice(1:10) 

otros <-
  orquideas %>% 
  st_drop_geometry() %>%
  filter(!is.na(species) & species != "") %>%
  group_by(species) %>% 
  summarise(registros = n()) %>%
  arrange(desc(registros)) %>%
  slice(11:232) %>%
  group_by(species = as.character("Otros")) %>%
  summarise(registros = sum(registros))

visualizacion_orquideas <-
  merge(orq_slice, otros, all = TRUE) 
  
# Grafico
plot_ly(visualizacion_orquideas, labels =  ~species, values = ~registros, type = 'pie',
        textposition = 'inside',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = "label+value",
        showlegend = TRUE,
        marker = list(line = list(color = "#ffffff", width = 1))
) %>%
  layout(title = 'Registro de orqu?deas en Costa Rica') %>%
  config(locale = "es")

# 4. Capa leaflet agrupada (clustered) 
# Creación de conjunto de datos con la cantidad de especies por provincia
orquideas_especies <-
  provincias %>%
  st_join(orquideas) %>%
  group_by(provincia.x) %>%
  summarize(especies = n())

# Paleta de colores
colores_especies <-
  colorNumeric(palette = "RdPu",
               domain = orquideas_especies$especies,
               na.color = "transparent")

# Mapa de registros de presencia
orquideas %>%
  dplyr::select(species, 
         canton,
         stateProvince,
         eventDate) %>%
  leaflet() %>%
  setView(lng = -84.0, lat = 10.0, zoom = 8) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik, group = "OpenStreetMap") %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas, group = "Esri.WorldGrayCanvas") %>%
  addTiles(urlTemplate = "https://mts1.google.com/vt/lyrs=s&hl=en&src=app&x={x}&y={y}&z={z}&s=G", attribution = 'Google', group = "Google") %>%
  addPolygons(
    data = orquideas_especies,
    fillColor = ~ colores_especies(orquideas_especies$especies),
    fillOpacity = 0.3,
    stroke = TRUE,
    color = "black",
    weight = 1,
    group = "Registros-provincias" 
    ) %>%
  addCircleMarkers(
    stroke = F,
    radius = 4,
    fillColor = "#c90094",
    fillOpacity = 1,
    popup = paste(
      paste(
        "<strong>Especie: </strong>", 
        orquideas$species),
      paste(
        "<strong>Provincia: </strong>", 
        orquideas$stateProvince),
      paste(
        "<strong>Cantón: </strong>", 
        orquideas$canton),
      paste(
      "<strong>Fecha: </strong>", 
      orquideas$eventDate),
      sep = '<br/>'
    ),
    clusterOptions = markerClusterOptions(),
    group = "Registros-orquideas"
  ) %>%
  addLayersControl(
    baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Google"),
    overlayGroups = c("Registros-provincias", "Registros-orquideas")
  ) %>%
  addResetMapButton() %>%
  addSearchOSM() %>%
  addMouseCoordinates() %>%
  addScaleBar(position = "bottomleft", options = scaleBarOptions(imperial = FALSE)) %>%
  addLegend(
    position = "bottomleft",
    values = orquideas_especies$especies,
    pal = colores_especies,
    group = "Registros-provincias",
    title = "Cantidad de <br>especies de<br>orquideas")

# 5. Capa leaflet raster
# Especificación del directorio de trabajo
setwd("C:/Users/abbyg/Desktop/Procesamiento de datos/Proyecto")
getwd()

# Obtención de la capa de altitud
alt <-
  raster::getData(
    "worldclim",
    var = "alt",
    res = .5,
    lon = -84,
    lat = 10
  )

# Reproyección de la capa de altitud a WGS84
alt <-
  alt %>%
  projectRaster(crs = 4326)

# Recorte de la capa de altitud con base en la capa vectorial de provincias
altitud <-
  alt %>%
  crop(provincias) %>%
  mask(provincias)

# Plantilla de raster
raster_plantilla <-
  altitud %>%
  aggregate(fact = 8)

# Rasterización
orquideas_raster_registros <-
  rasterize(orquideas,
            raster_plantilla,
            field = 1,
            fun = "count")

# Visualización de la Rasterización
plot(
  orquideas_raster_registros,
  ext = extent(280000, 660000, 880000, 1250000),
  main = "Cantidad de registros de orquideas",
  axes = TRUE
)

plot(provincias$geometry,
     add = TRUE)

# Paleta de colores
pal <-
  colorNumeric(
    c("#fde0dd", "#fcc5c0", "#fa9fb5", "#c51b8a", "#ae017e", "#7a0177"),
    values(orquideas_raster_regis.tros), 
    na.color = "transparent"
)

# Mapa de registros de presencia
leaflet() %>%
  setView(lng = -84.0, lat = 10.0, zoom = 8) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik, group = "OpenStreetMap") %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas, group = "Esri.WorldGrayCanvas") %>%
  addTiles(urlTemplate = "https://mts1.google.com/vt/lyrs=s&hl=en&src=app&x={x}&y={y}&z={z}&s=G", attribution = 'Google', group = "Google") %>%
  addPolygons(
    data = provincias,
    fillColor = FALSE,
    fillOpacity = 0,
    stroke = TRUE,
    color = "black",
    weight = 1,
    group = "Registros-provincias" 
  ) %>%
  addRasterImage(
    orquideas_raster_registros,
    colors = pal,
    opacity = 1,
    group = "Registros-Orquídeas"
  ) %>%
  addLayersControl(
    baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Google"),
    overlayGroups = c("Registros-provincias", "Registros-Orquídeas")
  ) %>%
  addResetMapButton() %>%
  addSearchOSM() %>%
  addMouseCoordinates() %>%
  addScaleBar(position = "bottomleft", options = scaleBarOptions(imperial = FALSE)) %>%
  addMiniMap(position = "bottomleft")
